# 과일바구니 (Fruitbasket) 시스템 아키텍처

## 전체 시스템 개요

본 시스템은 두 개의 독립된 서비스로 구성됩니다.

1. **과일바구니 (Fruitbasket)** - 농산물 가격 정보 서비스 및 정책 센터
2. **G2B 입찰공고 수집기** - 나라장터 용역 입찰공고 자동 수집 파이프라인

```
┌─────────────────────────────────────────────────────────────┐
│                    fruitbasket-legal                         │
│                                                             │
│  ┌──────────────────────┐    ┌────────────────────────────┐ │
│  │  과일바구니 웹 서비스   │    │  G2B 입찰공고 수집 파이프라인 │ │
│  │  (index.html)        │    │  (scraper.py)              │ │
│  └──────────────────────┘    └────────────────────────────┘ │
└─────────────────────────────────────────────────────────────┘
```

---

## 모듈 1: 과일바구니 웹 서비스 (Frontend)

### 구성 파일
- `index.html` — 단일 페이지 정적 사이트 (HTML + CSS + JS 인라인)

### 서브모듈 구조

```
index.html
├── [UI Layer]
│   ├── Hero 섹션         — 서비스 브랜딩, 애니메이션
│   ├── Navigation        — Sticky 내비게이션, Scroll-spy
│   ├── Price Snapshot    — 도매 시장 가격 동향 표시
│   ├── API 문서 (Beta)   — /v1/prices/search 엔드포인트 안내
│   ├── 정책 페이지        — 개인정보처리방침, 이용약관
│   ├── 데이터 출처        — KAMIS, data.go.kr 출처 표기
│   └── 수익 고지          — 쿠팡 파트너스 제휴 공지
│
├── [Style Layer]
│   ├── CSS Variables     — Light/Dark 모드 테마 변수
│   ├── Responsive Grid   — 모바일 퍼스트 반응형 레이아웃
│   └── Component Styles  — 카드, 배지, 배너 스타일
│
└── [Script Layer]
    └── Scroll-spy        — 스크롤 위치 기반 네비게이션 활성화
```

### 외부 의존성

| 대상 | 용도 |
|------|------|
| KAMIS API | 농산물 유통 가격 데이터 원천 |
| 공공데이터포털 (data.go.kr) | 공공 데이터 API 제공 |
| 쿠팡 파트너스 | 제휴 배너 및 수익화 |
| Google Search Console | 사이트 소유 인증 |

---

## 모듈 2: G2B 입찰공고 수집 파이프라인 (Backend)

### 구성 파일

| 파일 | 역할 |
|------|------|
| `scraper.py` | 메인 수집 애플리케이션 (266줄) |
| `config.json` | 검색 파라미터 설정 |
| `.env` / `.env.example` | API 키 관리 |
| `.github/workflows/daily-scrape.yml` | 자동 실행 스케줄러 |
| `requirements.txt` | Python 의존성 |
| `output/` | Excel 결과물 저장 디렉토리 |

### 서브모듈 구조 (scraper.py)

```
scraper.py
├── [Config 모듈]
│   ├── load_config()       — config.json 파싱
│   └── get_api_key()       — 환경변수에서 API 키 로드
│
├── [API Client 모듈]
│   ├── build_params()      — API 요청 파라미터 조립
│   ├── _request_with_retry() — HTTP 요청 + 지수 백오프 재시도
│   └── fetch_bids()        — 페이지네이션 기반 전체 데이터 수집
│
├── [Data Processing 모듈]
│   └── filter_by_keywords() — 키워드 기반 공고 필터링
│
├── [Output 모듈]
│   └── write_excel()       — 키워드별 시트 + 요약 시트 Excel 생성
│
└── [Orchestrator]
    └── main()              — 전체 파이프라인 실행 제어
```

### 설정 구조 (config.json)

```json
{
  "keywords": ["조사", "연구"],     // 필터링 키워드 목록
  "inqry_div": "1",               // 조회 구분 (1=용역)
  "num_of_rows": 999,             // 페이지당 조회 건수
  "days_back": 7,                 // 과거 N일 검색 범위
  "search_period": {
    "start_hour": "0000",         // 일별 검색 시작 시간
    "end_hour": "2359"            // 일별 검색 종료 시간
  }
}
```

---

## 데이터 흐름

### 흐름 1: G2B 수집 파이프라인 (일일 자동 실행)

```
[GitHub Actions Scheduler]
        │  매일 00:00 UTC (09:00 KST) 또는 수동 트리거
        ▼
┌──────────────────┐
│   main()         │ ← 오케스트레이터
└──────┬───────────┘
       │
       ▼
┌──────────────────┐     ┌──────────────┐
│  load_config()   │────▶│ config.json  │
└──────┬───────────┘     └──────────────┘
       │
       ▼
┌──────────────────┐     ┌──────────────┐
│  get_api_key()   │────▶│ .env / Secret│
└──────┬───────────┘     └──────────────┘
       │
       ▼
┌──────────────────┐     ┌─────────────────────────────────┐
│  build_params()  │     │  파라미터 조립                     │
│                  │     │  - 조회기간: today - days_back     │
│                  │     │  - 시간대: start_hour ~ end_hour  │
│                  │     │  - 구분: inqry_div (용역)          │
└──────┬───────────┘     └─────────────────────────────────┘
       │
       ▼
┌──────────────────────────────────────────────────┐
│  fetch_bids()                                     │
│  ┌──────────────────────────────────┐             │
│  │  _request_with_retry()           │             │
│  │  ┌─────────────┐                │             │
│  │  │ HTTP GET    │──▶ G2B API     │  페이지 반복 │
│  │  │ (timeout 30s)│◀── JSON 응답  │             │
│  │  └─────────────┘                │             │
│  │  실패 시: 지수 백오프 재시도       │             │
│  │  (2s → 4s → 8s, 최대 3회)       │             │
│  └──────────────────────────────────┘             │
│  결과: all_items[] (전체 입찰공고 목록)              │
└──────────┬───────────────────────────────────────┘
           │
           ▼
┌──────────────────────┐
│  filter_by_keywords()│
│  키워드별 공고명 매칭   │
│  "조사" → [매칭 결과]  │
│  "연구" → [매칭 결과]  │
└──────────┬───────────┘
           │
           ▼
┌──────────────────────────────────────┐
│  write_excel()                        │
│  ┌────────────────────────────────┐  │
│  │  Excel Workbook 생성            │  │
│  │  ├── 요약 시트 (키워드별 건수)   │  │
│  │  ├── "조사" 시트 (매칭 공고)     │  │
│  │  └── "연구" 시트 (매칭 공고)     │  │
│  └────────────────────────────────┘  │
│  → output/g2b_용역공고_YYYYMMDD.xlsx  │
└──────────┬───────────────────────────┘
           │
           ▼
┌──────────────────────┐
│  GitHub Actions      │
│  Artifact 업로드      │
│  (30일 보관)          │
└──────────────────────┘
```

### 흐름 2: 웹 서비스 (사용자 요청)

```
[사용자 브라우저]
       │
       ▼
┌──────────────────────────────┐
│  index.html (정적 호스팅)     │
│  ├── HTML 렌더링              │
│  ├── CSS 변수로 테마 자동 적용  │
│  │   └── prefers-color-scheme │
│  └── JS Scroll-spy 실행      │
└──────────────────────────────┘
       │
       ▼ (사용자 액션에 따라)
┌──────────────────────────────┐
│  외부 링크 이동               │
│  ├── API 호출 → api.fruitbasket.org (Beta)
│  └── 쿠팡 제휴 링크 → coupang.com
└──────────────────────────────┘
```

---

## 에러 처리 전략

```
_request_with_retry()
       │
       ├── ConnectionError ──▶ 재시도 (지수 백오프)
       ├── Timeout ──────────▶ 재시도 (지수 백오프)
       ├── HTTP 5xx ─────────▶ 재시도 (지수 백오프)
       ├── HTTP 4xx ─────────▶ 즉시 실패 (로깅)
       └── JSON 파싱 실패 ───▶ 즉시 중단 (로깅)

재시도 정책:
  - 최대 시도: 3회
  - 대기 시간: 2^(attempt+1) 초 → 2s, 4s, 8s
  - 요청 타임아웃: 30초
```

---

## 인프라 구성

```
┌─────────────────────────────────────────────────┐
│                 GitHub Repository                │
│                                                  │
│  ┌────────────────┐    ┌──────────────────────┐ │
│  │  GitHub Pages   │    │  GitHub Actions       │ │
│  │  (정적 호스팅)   │    │  (CI/CD)             │ │
│  │                 │    │                       │ │
│  │  index.html     │    │  daily-scrape.yml     │ │
│  │  ↕              │    │  ├── Python 3.11      │ │
│  │  fruitbasket    │    │  ├── pip install      │ │
│  │  -legal.org     │    │  ├── scraper.py 실행  │ │
│  └────────────────┘    │  └── Artifact 저장    │ │
│                         └──────────────────────┘ │
│                                                  │
│  ┌────────────────┐    ┌──────────────────────┐ │
│  │  Secrets        │    │  Artifacts            │ │
│  │  G2B_API_KEY    │    │  Excel 파일 (30일)    │ │
│  └────────────────┘    └──────────────────────┘ │
└─────────────────────────────────────────────────┘

외부 API:
  ┌──────────────────────────────────────────────┐
  │  apis.data.go.kr                              │
  │  /1230000/BidPublicInfoService/               │
  │  getBidPblancListInfoServc                    │
  │  (나라장터 입찰공고정보서비스)                    │
  └──────────────────────────────────────────────┘
```

---

## 기술 스택 요약

| 계층 | 기술 | 비고 |
|------|------|------|
| Frontend | HTML5, CSS3, Vanilla JS | 단일 파일, 프레임워크 없음 |
| Backend | Python 3.11 | CLI 스크립트 |
| HTTP Client | requests (>=2.31.0) | 재시도 로직 내장 |
| Data Export | openpyxl (>=3.1.2) | 서식 포함 Excel 생성 |
| Config | python-dotenv, JSON | 환경변수 + 설정 파일 |
| CI/CD | GitHub Actions | cron + workflow_dispatch |
| Hosting | GitHub Pages (추정) | 정적 사이트 |
| Timezone | KST (UTC+9) | 한국 표준시 기준 |
